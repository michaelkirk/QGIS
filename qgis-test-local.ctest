SET ( CTEST_SOURCE_DIRECTORY $ENV{QGIS_SRC_DIRECTORY} )
SET ( CTEST_BINARY_DIRECTORY $ENV{QGIS_BUILD_DIRECTORY} )

SET ( CTEST_CMAKE_GENERATOR  "Unix Makefiles" )
SET ( CTEST_CMAKE_COMMAND "cmake" )
SET ( CTEST_BUILD_COMMAND "/usr/bin/make -j2 -i -k" )
SET ( CTEST_SITE $ENV{HOSTNAME} )

EXECUTE_PROCESS( COMMAND uname -a OUTPUT_VARIABLE BUILD_NAME )
SET ( CTEST_BUILD_NAME ${BUILD_NAME} )

SET ( CTEST_BUILD_CONFIGURATION "Release" )

SET (INITIAL_CACHE "
BUILDNAME:STRING=${CTEST_BUILD_NAME}
SITE:STRING=${CTEST_SITE}
CTEST_USE_LAUNCHERS:BOOL=ON
")

SET (
  CTEST_NOTES_FILES
    ${CTEST_SCRIPT_DIRECTORY}/${CTEST_SCRIPT_NAME}
    ${CTEST_BINARY_DIRECTORY}/CMakeCache.txt
)

ctest_start( Experimental )
ctest_build()

ctest_test(BUILD "${CTEST_BINARY_DIRECTORY}" PARALLEL_LEVEL 2 RETURN_VALUE TESTRES)
IF( ${TESTRES} EQUAL 0 )
  MESSAGE( "Yay! All tests passed. ^_^" )
ELSE()
  MESSAGE( FATAL_ERROR "Test failed." )
ENDIF()

